name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: patika_${{ github.ref_name }}_linux_x86_64.tar.gz
            archive_cmd: tar -czf
          - os: windows-latest
            artifact_name: patika_${{ github.ref_name }}_windows_x86_64.zip
            archive_cmd: 7z a -tzip
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DPATIKA_BUILD_TESTS=ON -DCMAKE_INSTALL_PREFIX=dist
      
      - name: Build
        run: cmake --build build --config Release
      
      - name: Test
        run: ctest --test-dir build --output-on-failure --build-config Release
      
      - name: Install
        run: cmake --install build --config Release
      
      - name: Package (Linux)
        if: runner.os == 'Linux'
        working-directory: dist
        run: tar -czf ../patika_${{ steps.version.outputs.VERSION }}_linux_x86_64.tar.gz .
      
      - name: Package (Windows)
        if: runner.os == 'Windows'
        working-directory: dist
        run: 7z a -tzip ../patika_${{ steps.version.outputs.VERSION }}_windows_x86_64.zip .
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: patika_${{ steps.version.outputs.VERSION }}_${{ runner.os }}_x86_64
          path: patika_${{ steps.version.outputs.VERSION }}_*_x86_64.*
  
  create-release:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
